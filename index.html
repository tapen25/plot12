<button id="start">Start</button>
<script>
let audioCtx;
let lastTrigger = 0;
const threshold = 12; // 加速度衝撃のしきい値

document.getElementById('start').onclick = async () => {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  // iOS用：ユーザー操作後にセンサー許可
  if (DeviceMotionEvent.requestPermission) {
    await DeviceMotionEvent.requestPermission();
  }

  window.addEventListener("devicemotion", handleMotion);
};

function handleMotion(e) {
  const acc = e.accelerationIncludingGravity;
  if (!acc) return;

  const magnitude = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);

  const now = performance.now();
  if (magnitude > threshold && now - lastTrigger > 200) {
    lastTrigger = now;
    playFootstep(magnitude);
  }
}

function playFootstep(strength) {
  const t = audioCtx.currentTime;

  // ---------- Impact Layer ----------
  const impact = audioCtx.createBufferSource();
  const buffer = audioCtx.createBuffer(1, 4410, 44100);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < 200; i++) data[i] = (Math.random() * 2 - 1) * 0.6; 
  impact.buffer = buffer;

  const impactGain = audioCtx.createGain();
  impactGain.gain.setValueAtTime(0, t);
  impactGain.gain.linearRampToValueAtTime(0.5, t + 0.01);
  impactGain.gain.linearRampToValueAtTime(0, t + 0.05);

  // ---------- Texture Layer ----------
  const noise = audioCtx.createBufferSource();
  const buf = audioCtx.createBuffer(1, 44100, 44100);
  const d = buf.getChannelData(0);
  for (let i = 0; i < d.length; i++) d[i] = (Math.random()*2 - 1) * 0.2;
  noise.buffer = buf;

  const textureGain = audioCtx.createGain();
  textureGain.gain.setValueAtTime(0, t);
  textureGain.gain.linearRampToValueAtTime(0.3, t + 0.03);
  textureGain.gain.linearRampToValueAtTime(0, t + 0.15);

  // ---------- Dynamics Layer ----------
  const filter = audioCtx.createBiquadFilter();
  filter.type = "lowpass";
  filter.frequency.value = 1000 + strength * 80; // 歩行の強さ → 明るさ

  // MIX
  impact.connect(impactGain).connect(filter).connect(audioCtx.destination);
  noise.connect(textureGain).connect(filter).connect(audioCtx.destination);

  impact.start(t);
  noise.start(t);
}
</script>
