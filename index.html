<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walking BPM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #222; color: #fff; }
        #playBtn { padding: 20px 40px; font-size: 1.2rem; border-radius: 50px; border: none; background: #00d2ff; color: #000; cursor: pointer; }
        .status { margin-top: 20px; font-size: 1.5rem; font-variant-numeric: tabular-nums; }
        .info { font-size: 0.8rem; color: #aaa; margin-top: 10px; text-align: center; line-height: 1.4; }
    </style>
</head>
<body>

    <button id="playBtn">START</button>
    
    <div class="status">BPM: <span id="bpmDisplay">--</span></div>
    <div class="status" style="font-size: 1rem; color:#888;">Intensity: <span id="sdDisplay">--</span></div>
    
    <div class="info">
    </div>

<script>
class WalkingKickSystem {
    constructor() {
        // 設定
        this.smoothingFactor = 0.05; 
        this.minBPM = 100;
        this.maxBPM = 125;
        
        // データ管理
        this.buffer = [];
        this.currentBPM = 100;
        this.targetBPM = 100;
        this.isRunning = false;

        // Tone.js 初期化（音源作成）
        this.kick = new Tone.MembraneSynth().toDestination();
        this.loop = new Tone.Loop((time) => {
            this.kick.triggerAttackRelease("C1", "8n", time);
        }, "4n");
    }

    // センサデータの処理
    handleMotion(event) {
        const acc = event.acceleration || event.accelerationIncludingGravity;
        if (!acc) return;

        const x = acc.x || 0;
        const y = acc.y || 0;
        const z = acc.z || 0;

        // ベクトル合成
        const magnitude = Math.sqrt(x*x + y*y + z*z);

        // バッファリング
        this.buffer.push(magnitude);
        if (this.buffer.length > 120) this.buffer.shift();
    }

    // メインループ
    animate() {
        if (!this.isRunning) return;

        // SD計算
        let sd = 0;
        if (this.buffer.length > 2) {
            const mean = this.buffer.reduce((a, b) => a + b) / this.buffer.length;
            const variance = this.buffer.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / this.buffer.length;
            sd = Math.sqrt(variance);
        }
        
        // BPMマッピング
        const minSD = 0.5;
        const maxSD = 5.0;
        let normalized = (sd - minSD) / (maxSD - minSD);
        normalized = Math.max(0, Math.min(1, normalized));

        this.targetBPM = this.minBPM + (normalized * (this.maxBPM - this.minBPM));

        // 平滑化
        const diff = this.targetBPM - this.currentBPM;
        this.currentBPM += diff * this.smoothingFactor;

        // Tone反映
        Tone.Transport.bpm.value = this.currentBPM;

        // 表示更新
        document.getElementById('bpmDisplay').innerText = this.currentBPM.toFixed(1);
        document.getElementById('sdDisplay').innerText = sd.toFixed(2);

        requestAnimationFrame(() => this.animate());
    }
}

// インスタンス作成
const system = new WalkingKickSystem();

// --- ユーザーご提示のロジックを統合したイベントリスナ ---
document.getElementById("playBtn").addEventListener("click", async () => {
    const btn = document.getElementById("playBtn");

    // 1. iOS 13+ DeviceMotion Permission Request
    // HTTPS環境でないと、ここでエラーにならずともダイアログが出ない場合があります
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
            const response = await DeviceMotionEvent.requestPermission();
            if (response !== 'granted') {
                alert("センサの許可が必要です。リロードしてやり直してください。");
                return;
            }
        } catch (e) {
            console.error(e);
            alert("権限リクエストエラー: " + e);
            return;
        }
    }
    
    // 2. イベントリスナの登録
    // 【重要】クラスのメソッドを呼ぶため、アロー関数で包むか .bind(this) が必要です
    window.addEventListener("devicemotion", (e) => system.handleMotion(e));
    
    // 3. Audio Contextの開始 (Tone.js)
    await Tone.start();
    
    // 4. システム開始
    Tone.Transport.bpm.value = system.currentBPM;
    Tone.Transport.start();
    system.loop.start(0);
    system.isRunning = true;
    system.animate();
    
    // UI更新
    btn.style.display = "none";
});

</script>
</body>
</html>