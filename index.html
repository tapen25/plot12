<button id="start">Start</button>
<script>
let audioCtx;
let usePatternA = true;

// 2小節＝16個の8分音符 × 2パターン
const patterns = {
  A: [
    "C4","D4","E4","G4","E4","D4","C4","C4",
    "C4","E4","G4","A4","G4","E4","D4","C4"
  ],
  B: [
    "G4","A4","C5","A4","G4","E4","D4","C4",
    "D4","E4","G4","E4","D4","C4","C4","D4"
  ]
};

// ---------------------------
// ペンタトニック音階 → 周波数換算
// ---------------------------
function noteToFreq(note) {
  const map = {
    C4:-9, D4:-7, E4:-5, G4:-2, A4:0,
    C5:3
  };
  const semitone = map[note];
  return 440 * Math.pow(2, semitone/12);
}

document.getElementById("start").onclick = async () => {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  // iOS のセンサー許可
  if (DeviceMotionEvent.requestPermission) {
    await DeviceMotionEvent.requestPermission();
  }

  window.addEventListener("devicemotion", handleMotion);
};

// ---------------------------
// 加速度 → BPM に変換
// ---------------------------
let lastTrigger = 0;

function handleMotion(e) {
  const acc = e.accelerationIncludingGravity;
  if (!acc) return;

  const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);

  // 揺れが強いほど BPM が速くなる
  const BPM = mapAccelToBPM(mag);

  const now = performance.now();
  if (mag > 13 && now - lastTrigger > 500) { // 歩行トリガー
    lastTrigger = now;
    playPatternWithBPM(BPM);
  }
}

function mapAccelToBPM(a) {
  // だいたい 60〜180 BPM にマッピング
  const bpm = 60 + Math.min(120, (a - 10) * 10);
  return bpm;
}

// ---------------------------
// パターン（A or B）を BPM で再生
// ---------------------------
function playPatternWithBPM(bpm) {
  const now = audioCtx.currentTime;
  const pattern = usePatternA ? patterns.A : patterns.B;
  usePatternA = !usePatternA;

  // 8分音符の長さ（秒）
  const eighth = (60 / bpm) / 2;

  pattern.forEach((note, i) => {
    const freq = noteToFreq(note);

    const t = now + i * eighth;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.frequency.value = freq;

    // ちょっと跳ねるゲーム音風 ADSR
    gain.gain.setValueAtTime(0, t);
    gain.gain.linearRampToValueAtTime(0.25, t + 0.03);
    gain.gain.linearRampToValueAtTime(0, t + eighth * 0.9);

    osc.connect(gain).connect(audioCtx.destination);

    osc.start(t);
    osc.stop(t + eighth);
  });

  console.log("Playing at BPM:", bpm);
}
</script>
