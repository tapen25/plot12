<button id="start">Start (iOS„ÅØË¶Å„Çø„ÉÉ„Éó)</button>
<button id="stop">Stop</button>
<div id="status">ÂÅúÊ≠¢‰∏≠</div>
<div id="debug">BPM: 0</div>

<script>
let audioCtx;
let usePatternA = true;
let isPlaying = false; 
let currentNoteIndex = 0; 
let smoothedBPM = 60; 

// „Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞Áî®Â§âÊï∞
let nextNoteTime = 0.0;      
let timerID;                 
const scheduleAheadTime = 0.1; 
const lookahead = 25.0;      

// „Çª„É≥„Çµ„ÉºÂ±•Ê≠¥
let motionHistory = [];
const HISTORY_DURATION = 2000;

// „Éé„Éº„ÉàÂÆöÁæ©ÔºàPattern B„ÅØ9ÂÄã„ÅÇ„Çä„Åæ„Åô„Åå„ÄÅ„É™„Ç∫„É†„ÅØ„É´„Éº„Éó„Åó„Å¶ÈÅ©Áî®„Åï„Çå„Åæ„ÅôÔºâ
const patterns = {
  A: ["F3","Bb3","C4","D4", "C4","Bb3", "A3","G3"],
  B: ["G3","D4","Eb4","D4", "C4","Bb3", "Bb3","D3", "Bb3"]
};

// „É™„Ç∫„É†ÂÆöÁæ© (8ÂÄã)
const durations = [0.5, 0.5, 0.25, 0.25, 0.25, 0.25, 1.0, 1.0];

// Âë®Ê≥¢Êï∞Â§âÊèõ
function noteToFreq(note, offset = 0) {
  const map = {
    G3: -14, A3: -12, Bb3: -10, B3: -10, 
    C4: -9,  D4: -7, Eb4: -6, E4: -5, F4: -4, G4: -2, A4: 0, B4: 2,
    C5: 3, D3: -26 
  };
  
  let semitone = map[note] !== undefined ? map[note] : 0;
  semitone += offset;
  return 440 * Math.pow(2, semitone/12);
}

document.getElementById("start").onclick = async () => {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    await audioCtx.resume();
  }
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    await DeviceMotionEvent.requestPermission();
  }
  window.addEventListener("devicemotion", handleMotion);
  document.getElementById("status").innerText = "„Ç∑„Çß„Ç§„ÇØ„Åó„Å¶„Çπ„Çø„Éº„ÉàÔºÅ";
};

document.getElementById("stop").onclick = () => {
  isPlaying = false;
  clearTimeout(timerID);
  document.getElementById("status").innerText = "ÂÅúÊ≠¢";
};

// ---------------------------
// „Çª„É≥„Çµ„ÉºÂá¶ÁêÜ
// ---------------------------
function handleMotion(e) {
  const acc = e.accelerationIncludingGravity;
  if (!acc) return;
  const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
  const now = performance.now();

  motionHistory.push({ time: now, val: mag });
  motionHistory = motionHistory.filter(item => now - item.time < HISTORY_DURATION);

  let sum = 0;
  motionHistory.forEach(item => sum += item.val);
  const avgMag = sum / motionHistory.length || 0;

  smoothedBPM = mapAccelToBPM(avgMag);
  
  const isHighSpeed = smoothedBPM >= 120;
  document.getElementById("debug").innerText = `Avg BPM: ${Math.floor(smoothedBPM)} ${isHighSpeed ? "üî•HIGH" : ""}`;

  // „Éà„É™„Ç¨„ÉºÂà§ÂÆö
  if (!isPlaying && mag > 15) { 
    startSequence();
  }
}

function mapAccelToBPM(a) {
  let bpm = 100 + (a - 10) * 8; 
  if (bpm < 60) bpm = 60;
  if (bpm > 200) bpm = 200;
  return bpm;
}

// ---------------------------
// „Ç∑„Éº„Ç±„É≥„ÇπÈñãÂßãÂá¶ÁêÜ
// ---------------------------
function startSequence() {
  if (isPlaying) return;
  
  isPlaying = true;
  currentNoteIndex = 0;
  usePatternA = true;
  
  nextNoteTime = audioCtx.currentTime + 0.1;
  scheduler();
}

// ---------------------------
// „Çπ„Ç±„Ç∏„É•„Éº„É©„Éº
// ---------------------------
function scheduler() {
  if (!isPlaying) return;

  while (nextNoteTime < audioCtx.currentTime + scheduleAheadTime) {
    scheduleNote(currentNoteIndex, nextNoteTime);
    nextNote();
  }
  
  timerID = setTimeout(scheduler, lookahead);
}

// ‚òÖ‰øÆÊ≠£ÁÆáÊâÄÔºö„É™„Ç∫„É†ÈÖçÂàó„ÅÆÈï∑„Åï„ÇíË∂Ö„Åà„Å¶„ÇÇ„Ç®„É©„Éº„Å´„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´‰øÆÊ≠£
function nextNote() {
  const currentPattern = usePatternA ? patterns.A : patterns.B;
  
  // ‚òÖÈáçË¶Å: index „Åå durations „ÅÆÈï∑„Åï„ÇíË∂Ö„Åà„Åü„Çâ„ÄÅÊúÄÂàù(0Áï™ÁõÆ)„ÅÆ„É™„Ç∫„É†„Å´Êàª„Å£„Å¶‰Ωø„ÅÜ (%)
  const durationIndex = currentNoteIndex % durations.length;
  const durationVal = durations[durationIndex]; 

  const secondsPerBeat = 60.0 / smoothedBPM;
  nextNoteTime += durationVal * secondsPerBeat;

  currentNoteIndex++;

  // „Éë„Çø„Éº„É≥ÁµÇ‰∫ÜÊôÇ„ÅÆÂá¶ÁêÜ
  if (currentNoteIndex >= currentPattern.length) {
    currentNoteIndex = 0;
    usePatternA = !usePatternA; 
  }
}

// ---------------------------
// Èü≥„ÅÆ‰∫àÁ¥Ñ„Å®ÊèèÁîª‰∫àÁ¥Ñ
// ---------------------------
function scheduleNote(index, time) {
  const currentPattern = usePatternA ? patterns.A : patterns.B;
  const noteName = currentPattern[index];
  
  const pitchOffset = (smoothedBPM >= 120) ? 1 : 0;
  const freq = noteToFreq(noteName, pitchOffset);
  
  // Èï∑„Åï„ÅÆË®àÁÆó„Å´„ÇÇ % „Çí‰Ωø„ÅÜ
  const durationIndex = index % durations.length;
  const durationVal = durations[durationIndex];
  
  const secondsPerBeat = 60.0 / smoothedBPM;
  const noteDuration = durationVal * secondsPerBeat;

  playTone(freq, time, noteDuration);

  // ÁîªÈù¢Ë°®Á§∫
  const drawDelay = (time - audioCtx.currentTime) * 1000;
  setTimeout(() => {
    if(!isPlaying) return;
    document.getElementById("status").innerText = 
      `ÂÜçÁîü‰∏≠: ${usePatternA?"A":"B"} (${index+1}/${currentPattern.length})`;
  }, Math.max(0, drawDelay));
}

function playTone(freq, time, duration) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "triangle"; 
  osc.frequency.setValueAtTime(freq, time);

  const soundEnd = time + (duration * 0.9);

  gain.gain.setValueAtTime(0, time);
  gain.gain.linearRampToValueAtTime(0.3, time + 0.04); 
  gain.gain.exponentialRampToValueAtTime(0.001, soundEnd);

  osc.connect(gain).connect(audioCtx.destination);
  osc.start(time);
  osc.stop(time + duration);
}
</script>