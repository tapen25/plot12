<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Walking Agency Filter Test</title>
<style>
  body { font-family: sans-serif; padding: 20px; text-align: center; background: #f0f0f0; }
  button { font-size: 1.2rem; padding: 15px 30px; border-radius: 8px; border: none; background: #007AFF; color: white; cursor: pointer; }
  #status { margin-top: 20px; font-weight: bold; font-size: 1.2rem; }
  #debug { margin-top: 10px; color: #555; font-family: monospace; }
  #params { margin-top: 10px; font-size: 0.9rem; color: #333; }
</style>
</head>
<body>

<button id="start">Start (iOSã¯è¦ã‚¿ãƒƒãƒ—)</button>
<div id="status">åœæ­¢ä¸­</div>
<div id="debug">BPM: 0</div>
<div id="params">Tone: ---</div>

<script>
let audioCtx;
let isPlaying = false;

// ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ‡æ›¿
let usePatternA = true;

// å¹³å‡BPMï¼ˆåˆæœŸå€¤ï¼‰
let smoothedBPM = 60;

// åŠ é€Ÿåº¦ã®å±¥æ­´
let motionHistory = [];
// è¦æœ›ã«åˆã‚ã›ã¦ã€Œ3ã€œ5ç§’ã€ã®ä¸­é–“ã‚’ã¨ã£ã¦4ç§’ã«è¨­å®š
const HISTORY_DURATION = 4000; 

// å°ç¯€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ç”¨
let nextBarTime = 0;

// ãƒ‘ã‚¿ãƒ¼ãƒ³å®šç¾©
const patterns = {
  A: ["D4","C4","B3","D4","C4","A3","G3","A3","B3"],
  B: ["D4","C4","B3","D4","C4","A3","G3","B3","G3"]
};

// ãƒªã‚ºãƒ ï¼ˆ4åˆ†ï¼1.0ï¼‰
const durations = [0.25,0.25,0.25,0.25,0.5,0.5,0.5,0.5,1.0];

// ---------------------------
// éŸ³åâ†’å‘¨æ³¢æ•°
// ---------------------------
function noteToFreq(note, offset = 0) {
  const map = {
    G3:-14, A3:-12, B3:-10,
    C4:-9,  D4:-7,  E4:-5, F4:-4, G4:-2, A4:0, B4:2,
    C5:3
  };
  let semitone = map[note] ?? 0;
  semitone += offset;
  return 440 * Math.pow(2, semitone/12);
}

document.getElementById("start").onclick = async () => {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === "suspended") {
    await audioCtx.resume();
  }

  // iOS 13+ DeviceMotion Permission
  if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
    try {
      const permissionState = await DeviceMotionEvent.requestPermission();
      if (permissionState !== 'granted') {
        alert("ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒå¿…è¦ã§ã™");
        return;
      }
    } catch (e) {
      console.error(e);
    }
  }

  window.addEventListener("devicemotion", handleMotion);
  document.getElementById("status").innerText = "æ­©è¡Œå¾…æ©Ÿä¸­(å¼·ã‚ã«æ­©ã„ã¦é–‹å§‹)...";
  document.getElementById("start").style.display = 'none';
};

// ---------------------------
// ã‚»ãƒ³ã‚µãƒ¼å‡¦ç† â†’ å¹³å‡BPMç®—å‡º
// ---------------------------
function handleMotion(e) {
  const acc = e.accelerationIncludingGravity; // Android/iOSå·®åˆ†å¸åã®ãŸã‚é‡åŠ›è¾¼ã¿ã‚’ä½¿ç”¨
  if (!acc) return;

  // é‡åŠ›è¾¼ã¿ã®ãƒ™ã‚¯ãƒˆãƒ«é•·ã‹ã‚‰ç°¡æ˜“çš„ã«å‹•ãã®å¤§ãã•ã‚’å–ã‚‹
  // (é™æ­¢æ™‚ã§ã‚‚9.8ä»˜è¿‘ã«ãªã‚‹ãŒã€ç›¸å¯¾å¤‰åŒ–ã‚’è¦‹ã‚‹ãŸã‚ç°¡æ˜“å®Ÿè£…)
  const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
  const now = performance.now();

  motionHistory.push({time: now, val: mag});
  
  // å±¥æ­´æœŸé–“å¤–ã‚’å‰Šé™¤
  while(motionHistory.length > 0 && now - motionHistory[0].time > HISTORY_DURATION) {
    motionHistory.shift();
  }

  // å¹³å‡è¨ˆç®—
  let sum = 0;
  motionHistory.forEach(i => sum += i.val);
  const avg = sum / motionHistory.length || 0;

  // åŠ é€Ÿåº¦ã‹ã‚‰BPMã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
  smoothedBPM = mapAccelToBPM(avg);

  // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
  const isHigh = smoothedBPM >= 110;
  document.getElementById("debug").innerText = 
    `Avg BPM: ${Math.floor(smoothedBPM)} ${isHigh?"ğŸ”¥Active":""}`;

  // éŸ³è‰²ã®ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆä»Šã®BPMã§ã©ã†ã„ã†ãƒ•ã‚£ãƒ«ã‚¿ã«ãªã‚‹ã‹ï¼‰
  const fInfo = getFilterParams(smoothedBPM);
  document.getElementById("params").innerText = 
    `Cutoff: ${Math.floor(fInfo.freq)}Hz (${fInfo.desc})`;

  // é–‹å§‹ãƒˆãƒªã‚¬ãƒ¼ï¼ˆé–¾å€¤ã¯ãƒ‡ãƒã‚¤ã‚¹ã«ã‚ˆã£ã¦èª¿æ•´ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰
  // é‡åŠ›åˆ†(ç´„9.8) + å‹•ãåˆ†ã€‚ã“ã“ã§ã¯13ç¨‹åº¦ã‚’é–¾å€¤ã«è¨­å®š
  if (!isPlaying && mag > 13) {
    startSequence();
  }
}

// åŠ é€Ÿåº¦å¹³å‡å€¤(9.8ã€œ20ãã‚‰ã„) ã‚’ BPM(60ã€œ160) ã«ãƒãƒƒãƒ—
function mapAccelToBPM(a) {
  // é‡åŠ›åˆ†(ç´„9.8)ã‚’å¼•ã„ãŸã€Œå‹•ãæˆåˆ†ã€ã§è¨ˆç®—
  let val = a - 9.8; 
  if (val < 0) val = 0;

  // ä¿‚æ•°ã¯æ­©ãæ–¹ã«åˆã‚ã›ã¦èª¿æ•´
  let bpm = 60 + (val * 15); 

  if (bpm < 60) bpm = 60;
  if (bpm > 180) bpm = 180;
  return bpm;
}

// ---------------------------
// ãƒ•ã‚£ãƒ«ã‚¿ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç®—å‡º
// ---------------------------
function getFilterParams(bpm) {
  // BPM 60  -> Cutoff 400Hz (ã“ã‚‚ã‚‹: ãƒ•ãƒ«ãƒ¼ãƒˆ/ãƒªã‚³ãƒ¼ãƒ€ãƒ¼é¢¨)
  // BPM 140 -> Cutoff 3000Hz (é–‹ã: ãƒˆãƒ©ãƒ³ãƒšãƒƒãƒˆ/ã‚·ãƒ³ã‚»ãƒ–ãƒ©ã‚¹é¢¨)
  
  // ãƒãƒƒãƒ”ãƒ³ã‚°
  let t = (bpm - 60) / (140 - 60); // 0.0 ã€œ 1.0
  if (t < 0) t = 0;
  if (t > 1) t = 1;

  // æŒ‡æ•°çš„ãªã‚«ãƒ¼ãƒ–ã§é–‹ãæ–¹ãŒè‡ªç„¶ã«èã“ãˆã‚‹
  const minFreq = 300;
  const maxFreq = 4000;
  const freq = minFreq * Math.pow(maxFreq / minFreq, t);

  // Qå€¤ï¼ˆãƒ¬ã‚¾ãƒŠãƒ³ã‚¹ï¼‰ã‚‚å°‘ã—å¤‰åŒ–ã•ã›ã‚‹ï¼ˆé–‹ã„ãŸã¨ãã«å°‘ã—é‹­ãï¼‰
  const q = 1 + t * 4; 

  let desc = "Soft/Muffled";
  if (t > 0.4) desc = "Medium";
  if (t > 0.8) desc = "Bright/Brass";

  return { freq, q, desc };
}

// ---------------------------
// ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é–‹å§‹
// ---------------------------
function startSequence() {
  isPlaying = true;
  nextBarTime = audioCtx.currentTime + 0.1; 
  document.getElementById("status").innerText = "å†ç”Ÿä¸­";
}

// ---------------------------
// 1å°ç¯€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
// ---------------------------
function scheduleBar() {
  const pattern = usePatternA ? patterns.A : patterns.B;
  const beatDur = 60 / smoothedBPM; // ã“ã®æ™‚ç‚¹ã®BPMã§å°ç¯€ã®é•·ã•ã‚’æ±ºå®š
  const now = audioCtx.currentTime;
  
  // å°ç¯€ã®é–‹å§‹æ™‚ç‚¹ã§ã®ãƒ•ã‚£ãƒ«ã‚¿å…·åˆã‚’æ±ºå®š
  // â˜…ãƒã‚¤ãƒ³ãƒˆ: 1éŸ³ã”ã¨ã§ã¯ãªãå°ç¯€å˜ä½ã§çµ±ä¸€ã™ã‚‹ã‹ã€éŸ³ã”ã¨ã«å¤‰ãˆã‚‹ã‹ã€‚
  // ã“ã“ã§ã¯ã€Œãã®å°ç¯€ã®é›°å›²æ°—ã€ã¨ã—ã¦çµ±ä¸€è¨­å®šã—ã¾ã™ãŒã€
  // ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ã‚·ãƒ¼ã‚’é«˜ã‚ã‚‹ãªã‚‰ playTone å‘¼ã³å‡ºã—æ™‚ã«å†è¨ˆç®—ã™ã‚‹ã®ã‚‚ã‚ã‚Šã§ã™ã€‚
  const filterParams = getFilterParams(smoothedBPM);

  if (nextBarTime < now) {
    nextBarTime = now + 0.05;
  }

  let cursor = nextBarTime;

  for (let i = 0; i < pattern.length; i++) {
    const beatLen = durations[i];
    const durSec = beatLen * beatDur;

    // ãƒ”ãƒƒãƒã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¹æ™‚ã¯1ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä¸Šã’ã¦ã‚‚é¢ç™½ã„ãŒã€ä»Šå›ã¯ãƒ•ã‚£ãƒ«ã‚¿å®Ÿé¨“ãªã®ã§OFFï¼‰
    const freq = noteToFreq(pattern[i], 0);

    // éŸ³ã‚»ãƒƒãƒˆ
    playTone(freq, cursor, durSec, filterParams);
    
    cursor += durSec;
  }

  // æ¬¡ã®å°ç¯€é ­ã¸
  const totalBeats = durations.reduce((a,b)=>a+b, 0);
  nextBarTime += totalBeats * beatDur;

  usePatternA = !usePatternA;
}

// ---------------------------
// éŸ³å†ç”Ÿï¼ˆSawtooth + LowPassFilterï¼‰
// ---------------------------
function playTone(freq, time, dur, fParams) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  const filter = audioCtx.createBiquadFilter();

  // â˜…å¤‰æ›´ç‚¹: ãƒã‚³ã‚®ãƒªæ³¢ï¼ˆå€éŸ³ãŒè±Šã‹ï¼å‰Šã‚ŠãŒã„ãŒã‚ã‚‹ï¼‰
  osc.type = "sawtooth";
  osc.frequency.value = freq;

  // â˜…å¤‰æ›´ç‚¹: ãƒ•ã‚£ãƒ«ã‚¿è¨­å®š
  filter.type = "lowpass";
  filter.frequency.value = fParams.freq;
  filter.Q.value = fParams.q;

  // æ¥ç¶š: Osc -> Filter -> Gain -> Out
  osc.connect(filter);
  filter.connect(gain);
  gain.connect(audioCtx.destination);

  // ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ï¼ˆéŸ³é‡ï¼‰
  // å°‘ã—ã‚¢ã‚¿ãƒƒã‚¯ã‚’é…ãã™ã‚‹ã¨ç®¡æ¥½å™¨ã£ã½ããªã‚‹
  gain.gain.setValueAtTime(0, time);
  gain.gain.linearRampToValueAtTime(0.4, time + 0.05); 
  gain.gain.exponentialRampToValueAtTime(0.001, time + dur * 0.95);

  // ãƒ•ã‚£ãƒ«ã‚¿ã«ã‚‚ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ã‚’å°‘ã—ã‹ã‘ã‚‹ã¨ã€Œãƒ¯ã‚¦ã€æ„ŸãŒå‡ºã¦ã‚ˆã‚Šæ¥½å™¨ã‚‰ã—ããªã‚‹
  // ã“ã“ã§ã¯æ§ãˆã‚ã«ã€éŸ³ã®å‡ºã ã—ã§å°‘ã—é–‹ãå‹•ãã‚’å…¥ã‚Œã‚‹
  filter.frequency.setValueAtTime(fParams.freq * 0.8, time);
  filter.frequency.linearRampToValueAtTime(fParams.freq, time + 0.05);

  osc.start(time);
  osc.stop(time + dur);
}

// ---------------------------
// ãƒ«ãƒ¼ãƒ—ç›£è¦–
// ---------------------------
setInterval(() => {
  if (!isPlaying) return;
  const now = audioCtx.currentTime;
  // å…ˆèª­ã¿
  if (nextBarTime - now < 0.1) {
    scheduleBar();
  }
}, 25);
</script>

</body>
</html>