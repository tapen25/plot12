<button id="start">Start (iOSã¯è¦ã‚¿ãƒƒãƒ—)</button>
<div id="status">åœæ­¢ä¸­</div>
<div id="debug">BPM: 0</div>

<script>
let audioCtx;
let usePatternA = true;
let isPlaying = false; 
let currentNoteIndex = 0; 
let smoothedBPM = 60; // 2ç§’é–“ã®å¹³å‡ã‹ã‚‰ç®—å‡ºã—ãŸBPM

// éå»ã®åŠ é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é…åˆ— {time: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—, val: åŠ é€Ÿåº¦}
let motionHistory = [];
const HISTORY_DURATION = 2000; // 2ç§’é–“ (ãƒŸãƒªç§’)

// ãƒãƒ¼ãƒˆï¼ˆéŸ³ç¨‹ï¼‰å®šç¾©
const patterns = {
  A: ["D4","C#4","B3","D4", "C#4","A3", "G3","A3", "B3"],
  B: ["D4","C#4","B3","D4", "C#4","A3", "G3","B3", "G3"]
};

// ãƒªã‚ºãƒ ï¼ˆé•·ã•ï¼‰å®šç¾© (1.0 = 4åˆ†éŸ³ç¬¦)
const durations = [0.25, 0.25, 0.25, 0.25, 0.5, 0.5, 0.5, 0.5, 1.0];

// ---------------------------
// éŸ³å â†’ å‘¨æ³¢æ•°æ›ç®—
// ---------------------------
function noteToFreq(note, offset = 0) {
  const map = {
    G3: -14, A3: -12, B3: -10,
    C4: -9,  D4: -7,  E4: -5, F4: -4, G4: -2, A4: 0, B4: 2,
    C5: 3
  };
  
  let semitone = map[note];
  if (semitone === undefined) semitone = 0;
  
  // ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’åŠ ç®—ï¼ˆBPM120ä»¥ä¸Šã§+1ã•ã‚Œã‚‹ï¼‰
  semitone += offset;

  return 440 * Math.pow(2, semitone/12);
}

document.getElementById("start").onclick = async () => {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === 'suspended') {
    await audioCtx.resume();
  }
  
  if (typeof DeviceMotionEvent.requestPermission === 'function') {
    await DeviceMotionEvent.requestPermission();
  }

  window.addEventListener("devicemotion", handleMotion);
  document.getElementById("status").innerText = "ã‚»ãƒ³ã‚µãƒ¼å¾…æ©Ÿä¸­...";
};

// ---------------------------
// ã‚»ãƒ³ã‚µãƒ¼å‡¦ç†ï¼šãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ã—ã€å¹³å‡BPMã‚’ç®—å‡º
// ---------------------------
function handleMotion(e) {
  const acc = e.accelerationIncludingGravity;
  if (!acc) return;

  const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
  const now = performance.now();

  // 1. å±¥æ­´ã«è¿½åŠ 
  motionHistory.push({ time: now, val: mag });

  // 2. 2ç§’ä»¥ä¸Šå‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ (ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°)
  motionHistory = motionHistory.filter(item => now - item.time < HISTORY_DURATION);

  // 3. å¹³å‡å€¤ã‚’è¨ˆç®—
  let sum = 0;
  motionHistory.forEach(item => sum += item.val);
  const avgMag = sum / motionHistory.length || 0;

  // 4. å¹³å‡å€¤ã‹ã‚‰BPMã‚’æ±ºå®š (ã“ã“ãŒå®‰å®šã—ãŸBPMã«ãªã‚Šã¾ã™)
  smoothedBPM = mapAccelToBPM(avgMag);
  
  // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
  const isHighSpeed = smoothedBPM >= 120;
  document.getElementById("debug").innerText = `Avg BPM: ${Math.floor(smoothedBPM)} ${isHighSpeed ? "ğŸ”¥HIGH" : ""}`;

  // 5. ãƒˆãƒªã‚¬ãƒ¼åˆ¤å®šï¼ˆé–‹å§‹æ™‚ã ã‘ã¯ç¬ç™ºåŠ›ã‚’è¦‹ãŸã„ã®ã§ã€ç¾åœ¨ã® mag ã‚‚ä½¿ã†ï¼‰
  // åœæ­¢ä¸­ã§ã€ã‹ã¤ã€Œä»Šå¼·ãæŒ¯ã£ãŸã€å ´åˆã«ã‚¹ã‚¿ãƒ¼ãƒˆ
  if (!isPlaying && mag > 15) { 
    startSequence();
  }
}

function mapAccelToBPM(a) {
  // 110ã€œ150ãã‚‰ã„ã¾ã§å¤‰åŒ–
  let bpm = 100 + (a - 10) * 8; 
  if (bpm < 60) bpm = 60;
  if (bpm > 200) bpm = 200;
  return bpm;
}

// ---------------------------
// ã‚·ãƒ¼ã‚±ãƒ³ã‚¹é–‹å§‹å‡¦ç†
// ---------------------------
function startSequence() {
  isPlaying = true;
  currentNoteIndex = 0;
  playNextNote(); 
}

// ---------------------------
// å†ç”Ÿå‡¦ç†
// ---------------------------
function playNextNote() {
  const currentPattern = usePatternA ? patterns.A : patterns.B;
  
  // ãƒ‘ã‚¿ãƒ¼ãƒ³çµ‚äº†ãƒã‚§ãƒƒã‚¯
  if (currentNoteIndex >= currentPattern.length) {
    finishSequence();
    return;
  }

  const now = audioCtx.currentTime;
  const noteName = currentPattern[currentNoteIndex];
  const durationVal = durations[currentNoteIndex];

  // â˜… 2ç§’é–“ã®å¹³å‡BPM (smoothedBPM) ã‚’ä½¿ç”¨ã—ã¦é•·ã•ã‚’æ±ºã‚ã‚‹
  const beatDuration = 60 / smoothedBPM; 
  const noteTimeLen = beatDuration * durationVal;

  // â˜… å¹³å‡BPMãŒ120ä»¥ä¸Šãªã‚‰åŠéŸ³ä¸Šã’ã‚‹
  const pitchOffset = (smoothedBPM >= 120) ? 1 : 0;
  const freq = noteToFreq(noteName, pitchOffset);

  // éŸ³ã‚’é³´ã‚‰ã™
  playTone(freq, now, noteTimeLen);
  
  document.getElementById("status").innerText = 
    `å†ç”Ÿä¸­: ${usePatternA?"A":"B"} (${currentNoteIndex+1}/${currentPattern.length})`;

  // æ¬¡ã®éŸ³ã®äºˆç´„
  setTimeout(() => {
    currentNoteIndex++;
    playNextNote(); 
  }, noteTimeLen * 1000); 
}

// ---------------------------
// å˜éŸ³å†ç”Ÿç”¨é–¢æ•°ï¼ˆæŸ”ã‚‰ã‹ã„éŸ³è¨­å®šï¼‰
// ---------------------------
function playTone(freq, time, duration) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  // â˜… å¤‰æ›´ç‚¹: ä¸‰è§’æ³¢ã§æŸ”ã‚‰ã‹ã
  osc.type = "triangle"; 
  osc.frequency.value = freq;

  // éŸ³ã®çµ‚ã‚ã‚Šï¼ˆå°‘ã—çŸ­ãã—ã¦æ­¯åˆ‡ã‚Œã‚ˆãã™ã‚‹ã®ã¯ç¶­æŒï¼‰
  const soundEnd = time + (duration * 0.9);

  // â˜… ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—èª¿æ•´ï¼ˆæŸ”ã‚‰ã‹ã‚ï¼‰
  gain.gain.setValueAtTime(0, time);
  // ã‚¢ã‚¿ãƒƒã‚¯ã‚’å°‘ã—é…ã(0.01 -> 0.04)ã—ã¦ã€Œãƒãƒ¯ãƒƒã€ã¨ã•ã›ã‚‹
  gain.gain.linearRampToValueAtTime(0.3, time + 0.04); 
  gain.gain.exponentialRampToValueAtTime(0.001, soundEnd);

  osc.connect(gain).connect(audioCtx.destination);
  osc.start(time);
  osc.stop(time + duration);
}

function finishSequence() {
  isPlaying = false;
  usePatternA = !usePatternA; 
  document.getElementById("status").innerText = "å¾…æ©Ÿä¸­...";
}
</script>