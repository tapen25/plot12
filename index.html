<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Walking Agency - Tone.js Instruments</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; text-align: center; background: #f0f0f0; }
  button { font-size: 1.2rem; padding: 15px 30px; border-radius: 8px; border: none; background: #007AFF; color: white; cursor: pointer; }
  button:disabled { background: #ccc; cursor: not-allowed; }
  #status { margin-top: 20px; font-weight: bold; font-size: 1.2rem; }
  #debug { margin-top: 10px; color: #555; font-family: monospace; }
  #params { margin-top: 10px; font-size: 0.9rem; color: #333; }
</style>
</head>
<body>

<button id="start" disabled>Loading Sounds...</button>
<div id="status">Èü≥Ê∫êË™≠„ÅøËæº„Åø‰∏≠...</div>
<div id="debug">BPM: 0</div>
<div id="params">Tone: ---</div>

<script>
// ---------------------------
// Tone.js „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
// ---------------------------
let sampler;
let globalFilter;
let reverb;

// Ê•ΩÂô®„ÅÆË®≠ÂÆöÔºàTrumpet„Çí‰ΩøÁî®Ôºâ
// „Éï„Ç£„É´„Çø„ÅÆÂ§âÂåñÔºà„Åì„ÇÇ„Çã‚áîÈñã„ÅèÔºâ„ÅåÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑÊ•ΩÂô®„ÇíÈÅ∏ÂÆö„Åó„Å¶„ÅÑ„Åæ„Åô
const sampleBaseUrl = "https://nbrosowsky.github.io/tonejs-instruments/samples/trumpet/";
const sampleMap = {
  "C4": "C4.wav",
  "D#4": "Ds4.wav",
  "F#4": "Fs4.wav",
  "A4": "A4.wav",
  "C5": "C5.wav" // È´òÈü≥ÂüüÁî®
};

// ÂàùÊúüÂåñÂá¶ÁêÜ
async function setupAudio() {
  // 1. „É≠„Éº„Éë„Çπ„Éï„Ç£„É´„Çø„Éº‰ΩúÊàê (ÂàùÊúüÂÄ§ 400Hz)
  globalFilter = new Tone.Filter(400, "lowpass").toDestination();

  // 2. „É™„Éê„Éº„ÉñÔºàÁ©∫Èñì„ÅÆÂ∫É„Åå„ÇäÔºâ„ÇíËøΩÂä†„Åó„Å¶„É™„ÉÉ„ÉÅ„Å´„Åô„Çã
  reverb = new Tone.Reverb({ decay: 2, wet: 0.3 }).connect(globalFilter);

  // 3. „Çµ„É≥„Éó„É©„Éº‰ΩúÊàê
  sampler = new Tone.Sampler({
    urls: sampleMap,
    baseUrl: sampleBaseUrl,
    onload: () => {
      // Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÊôÇ
      const btn = document.getElementById("start");
      btn.innerText = "Start (Tap to Walk)";
      btn.disabled = false;
      document.getElementById("status").innerText = "Ê∫ñÂÇôÂÆå‰∫Ü„ÄÇ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶Ê≠©„ÅçÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
    }
  }).connect(reverb);
}

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Ç™„Éº„Éá„Ç£„Ç™Ê∫ñÂÇôÈñãÂßã
setupAudio();


// ---------------------------
// Â§âÊï∞„Éª„É≠„Ç∏„ÉÉ„ÇØÂÆöÁæ©
// ---------------------------
let isPlaying = false;
let usePatternA = true;
let smoothedBPM = 60;
let motionHistory = [];
const HISTORY_DURATION = 4000; 
let nextBarTime = 0;

// „Éë„Çø„Éº„É≥ÂÆöÁæ©
const patterns = {
  A: ["D4","C4","B3","D4","C4","A3","G3","A3","B3"],
  B: ["D4","C4","B3","D4","C4","A3","G3","B3","G3"]
};
const durations = [0.25,0.25,0.25,0.25,0.5,0.5,0.5,0.5,1.0];

// ---------------------------
// „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©
// ---------------------------
document.getElementById("start").onclick = async () => {
  // Tone.js„ÅÆ„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÈñãÂßãÔºàÂøÖÈ†àÔºâ
  await Tone.start();
  
  if (Tone.context.state !== 'running') {
    await Tone.context.resume();
  }

  // iOS DeviceMotion Permission
  if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
    try {
      const permissionState = await DeviceMotionEvent.requestPermission();
      if (permissionState !== 'granted') {
        alert("„Çª„É≥„Çµ„ÉºË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô");
        return;
      }
    } catch (e) {
      console.error(e);
    }
  }

  window.addEventListener("devicemotion", handleMotion);
  document.getElementById("status").innerText = "Ê≠©Ë°åÂæÖÊ©ü‰∏≠(Âº∑„ÇÅ„Å´Ê≠©„ÅÑ„Å¶ÈñãÂßã)...";
  document.getElementById("start").style.display = 'none';
};

// ---------------------------
// „Çª„É≥„Çµ„ÉºÂá¶ÁêÜ ‚Üí BPM & „Éï„Ç£„É´„ÇøÂà∂Âæ°
// ---------------------------
function handleMotion(e) {
  const acc = e.accelerationIncludingGravity;
  if (!acc) return;

  const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
  const now = performance.now();

  motionHistory.push({time: now, val: mag});
  while(motionHistory.length > 0 && now - motionHistory[0].time > HISTORY_DURATION) {
    motionHistory.shift();
  }

  let sum = 0;
  motionHistory.forEach(i => sum += i.val);
  const avg = sum / motionHistory.length || 0;

  // BPMË®àÁÆó
  smoothedBPM = mapAccelToBPM(avg);

  // „Éï„Ç£„É´„Çø„Éë„É©„É°„Éº„ÇøË®àÁÆó
  const fInfo = getFilterParams(smoothedBPM);

  // ‚òÖTone.js„ÅÆ„Éï„Ç£„É´„Çø„Çí„É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
  // rampTo„Çí‰Ωø„Å£„Å¶Êªë„Çâ„Åã„Å´Â§âÂåñ„Åï„Åõ„ÇãÔºà0.1Áßí„Åã„Åë„Å¶Â§âÂåñÔºâ
  if(globalFilter) {
    globalFilter.frequency.rampTo(fInfo.freq, 0.1);
    globalFilter.Q.value = fInfo.q;
  }

  // „Éá„Éê„ÉÉ„Ç∞Ë°®Á§∫
  const isHigh = smoothedBPM >= 110;
  document.getElementById("debug").innerText = 
    `Avg BPM: ${Math.floor(smoothedBPM)} ${isHigh?"üî•Active":""}`;
  document.getElementById("params").innerText = 
    `Filter: ${Math.floor(fInfo.freq)}Hz (${fInfo.desc})`;

  // ÈñãÂßã„Éà„É™„Ç¨„Éº
  if (!isPlaying && mag > 13) {
    startSequence();
  }
}

function mapAccelToBPM(a) {
  let val = a - 9.8; 
  if (val < 0) val = 0;
  let bpm = 60 + (val * 15); 
  if (bpm < 60) bpm = 60;
  if (bpm > 180) bpm = 180;
  return bpm;
}

// ---------------------------
// „Éï„Ç£„É´„ÇøË®àÁÆó„É≠„Ç∏„ÉÉ„ÇØ
// ---------------------------
function getFilterParams(bpm) {
  // BPM 60 (Slow) -> 300Hz (Muffled)
  // BPM 140 (Fast) -> 2500Hz (Bright)
  let t = (bpm - 60) / (140 - 60); 
  if (t < 0) t = 0;
  if (t > 1) t = 1;

  const minFreq = 300;
  const maxFreq = 2500; // „Çµ„É≥„Éó„É™„É≥„Ç∞Èü≥Ê∫ê„Å™„ÅÆ„ÅßÂ∞ë„ÅóÈ´ò„ÇÅ„Åæ„ÅßÈñã„Åë„Çã
  const freq = minFreq * Math.pow(maxFreq / minFreq, t);
  const q = 1 + t * 2; 

  let desc = "Soft";
  if (t > 0.4) desc = "Medium";
  if (t > 0.8) desc = "Bright";

  return { freq, q, desc };
}

// ---------------------------
// „Ç∑„Éº„Ç±„É≥„ÇπÈñãÂßã
// ---------------------------
function startSequence() {
  isPlaying = true;
  nextBarTime = Tone.now() + 0.1; 
  document.getElementById("status").innerText = "ÂÜçÁîü‰∏≠";
  requestAnimationFrame(schedulerLoop);
}

// ---------------------------
// „Çπ„Ç±„Ç∏„É•„Éº„É™„É≥„Ç∞„É´„Éº„Éó
// ---------------------------
function schedulerLoop() {
  if (!isPlaying) return;

  // 0.1ÁßíÂÖà„Åæ„Åß„Çπ„Ç±„Ç∏„É•„Éº„É´
  const lookahead = 0.1;
  if (nextBarTime < Tone.now() + lookahead) {
    scheduleBar();
  }

  requestAnimationFrame(schedulerLoop);
}

function scheduleBar() {
  const pattern = usePatternA ? patterns.A : patterns.B;
  const beatDur = 60 / smoothedBPM; // ÁèæÂú®„ÅÆBPM„Çí‰ΩøÁî®
  
  let cursor = nextBarTime;

  for (let i = 0; i < pattern.length; i++) {
    const beatLen = durations[i];
    const durSec = beatLen * beatDur;
    const note = pattern[i];

    // ‚òÖTone.js Sampler„ÅßÂÜçÁîü
    // triggerAttackRelease(Èü≥Èöé, ÊåÅÁ∂öÊôÇÈñì, ÂÜçÁîüÊôÇÂàª, „Éô„É≠„Ç∑„ÉÜ„Ç£)
    // „Éô„É≠„Ç∑„ÉÜ„Ç£(Èü≥„ÅÆÂº∑„Åï)„ÇÇBPM„Å´Âøú„Åò„Å¶Â∞ë„ÅóÂ§â„Åà„Çã„Å®Áîü„Å£„ÅΩ„Åè„Å™„Çä„Åæ„Åô
    const velocity = 0.5 + (smoothedBPM / 300); // ÈÄü„ÅÑ„Å®Âº∑„ÅèÂè©„Åè
    
    sampler.triggerAttackRelease(note, durSec * 0.9, cursor, velocity);
    
    cursor += durSec;
  }

  const totalBeats = durations.reduce((a,b)=>a+b, 0);
  nextBarTime += totalBeats * beatDur;

  usePatternA = !usePatternA;
}

</script>

</body>
</html>