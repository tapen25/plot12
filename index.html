<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walking BPM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background: #222; color: #fff; }
        #playBtn { padding: 20px 40px; font-size: 1.2rem; border-radius: 50px; border: none; background: #00d2ff; color: #000; cursor: pointer; }
        .status { margin-top: 20px; font-size: 1.5rem; font-variant-numeric: tabular-nums; }
        .info { font-size: 0.8rem; color: #aaa; margin-top: 10px; text-align: center; line-height: 1.4; }
    </style>
</head>
<body>

    <button id="playBtn">START</button>
    
    <div class="status">BPM: <span id="bpmDisplay">--</span></div>
    <div class="status" style="font-size: 1rem; color:#888;">Steps/min: <span id="spmDisplay">--</span></div>

<script>
class WalkingKickSystem {
    constructor() {

        // 音楽的な設定
        this.smoothingFactor = 0.05;  // じわじわ追従
        this.rateLimit = 3;           // 1フレームあたり最大変化BPM量（音楽的）
        this.minBPM = 100;
        this.maxBPM = 125;

        // ステップ検出
        this.prevMagnitude = 0;
        this.prevPrevMagnitude = 0;
        this.threshold = 1.2;         // 歩行ピーク検出用（必要なら微調整）
        this.stepTimestamps = [];

        // BPM管理
        this.currentBPM = 110;
        this.targetBPM = 110;
        this.isRunning = false;

        // Kick
        this.kick = new Tone.MembraneSynth().toDestination();
        this.loop = new Tone.Loop((time) => {
            this.kick.triggerAttackRelease("C1", "8n", time);
        }, "4n");
    }

    // ---- 加速度 → ステップ検出 ----
    handleMotion(event) {
        const acc = event.acceleration || event.accelerationIncludingGravity;
        if (!acc) return;

        const magnitude = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
        const now = Date.now();

        // ピーク検出：上昇→下降＋しきい値
        if (
            this.prevMagnitude > this.prevPrevMagnitude &&
            this.prevMagnitude > magnitude &&
            this.prevMagnitude > this.threshold
        ) {
            this.stepTimestamps.push(now);
        }

        // 古いデータ削除（10秒以上前）
        this.stepTimestamps = this.stepTimestamps.filter(t => now - t < 10000);

        this.prevPrevMagnitude = this.prevMagnitude;
        this.prevMagnitude = magnitude;
    }

    // ---- 歩行周期 → BPM 計算 ----
    updateTargetBPM() {
        const ts = this.stepTimestamps;
        if (ts.length < 3) return 0;

        const durationMs = ts[ts.length - 1] - ts[0];
        const steps = ts.length - 1;
        if (durationMs <= 0) return;

        const spm = steps / (durationMs / 60000);  // steps per minute

        // BPM範囲制限 + 音楽的に補正
        this.targetBPM = Math.max(this.minBPM, Math.min(this.maxBPM, spm));

        return spm;
    }

    // ---- メイン更新ループ ----
    animate() {
        if (!this.isRunning) return;

        // ステップから BPM 計算
        const spm = this.updateTargetBPM();

        // BPM 変化幅制限（音楽的にする）
        let diff = this.targetBPM - this.currentBPM;
        diff = Math.min(this.rateLimit, Math.max(-this.rateLimit, diff));

        // じわじわ追従
        this.currentBPM += diff * this.smoothingFactor;

        // Tone に反映
        Tone.Transport.bpm.value = this.currentBPM;

        // 表示
        document.getElementById('bpmDisplay').innerText = this.currentBPM.toFixed(1);
        if (spm) document.getElementById('spmDisplay').innerText = spm.toFixed(0);

        requestAnimationFrame(() => this.animate());
    }
}

// ---- インスタンス作成 ----
const system = new WalkingKickSystem();

document.getElementById("playBtn").addEventListener("click", async () => {
    const btn = document.getElementById("playBtn");

    // iOS用センサ許可
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        const response = await DeviceMotionEvent.requestPermission();
        if (response !== 'granted') {
            alert("センサの許可が必要です。");
            return;
        }
    }

    // センサ開始
    window.addEventListener("devicemotion", (e) => system.handleMotion(e));

    // Tone.js開始
    await Tone.start();
    Tone.Transport.start();
    system.loop.start(0);

    system.isRunning = true;
    system.animate();

    btn.style.display = "none";
});
</script>

</body>
</html>
